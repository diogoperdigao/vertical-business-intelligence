<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Virkmart Â· Denmark Market Intelligence Â· Real Data</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root {
  --bg: #F4F1EA;
  --card: #FFFFFF;
  --ink: #1A1714;
  --ink2: #5C5650;
  --ink3: #9E9890;
  --rule: #E2DDD6;
  --gold: #C9881A;
  --gold-pale: #FBF3E0;
  --green: #1E6B42;
  --green-pale: #EAF4EE;
  --red: #9B2020;
  --red-pale: #FBEAEA;
  --blue: #1A4A8A;
  --blue-pale: #EAF0FB;
  --teal: #1A6878;
  --teal-pale: #EAF4F7;
  --radius: 10px;
}
*,*::before,*::after { margin:0;padding:0;box-sizing:border-box }
html { scroll-behavior: smooth }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--ink); min-height:100vh; font-size:14px; line-height:1.6; }

/* â”€â”€ HEADER â”€â”€ */
.header { background:var(--ink); padding:0 40px; display:flex; align-items:center; justify-content:space-between; height:58px; position:sticky; top:0; z-index:100; }
.header-brand { display:flex; align-items:center; gap:14px; }
.header-flag { font-size:20px; }
.header-title { font-family:'Instrument Serif',serif; font-size:18px; color:#fff; letter-spacing:-0.3px; }
.header-sub { font-size:11px; font-weight:500; letter-spacing:2.5px; text-transform:uppercase; color:rgba(255,255,255,0.35); }
.bq-badge { display:flex; align-items:center; gap:7px; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.12); border-radius:100px; padding:6px 14px; }
.bq-dot { width:7px; height:7px; border-radius:50%; background:#4CAF50; box-shadow:0 0 6px #4CAF50; animation:pulse 2s infinite; }
.bq-label { font-size:11px; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.6); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

/* â”€â”€ MAIN â”€â”€ */
main { max-width:1280px; margin:0 auto; padding:28px 32px 48px; }

/* â”€â”€ REAL DATA BANNER â”€â”€ */
.real-data-banner {
  background: var(--ink);
  border-radius: var(--radius);
  padding: 22px 28px;
  margin-bottom: 20px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 24px;
  flex-wrap: wrap;
}
.rdb-left { flex: 1; min-width: 300px; }
.rdb-title {
  font-family: 'Instrument Serif', serif;
  font-size: 20px;
  color: #fff;
  margin-bottom: 8px;
}
.rdb-desc { font-size: 12.5px; color: rgba(255,255,255,0.55); line-height: 1.7; }
.rdb-desc strong { color: rgba(255,255,255,0.85); }
.rdb-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.rdb-chip {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 100px; padding: 4px 12px; font-size: 11px; font-weight: 600;
  letter-spacing: 1px; text-transform: uppercase; color: rgba(255,255,255,0.6);
}
.rdb-chip span { color: var(--gold); }
.rdb-right { min-width: 260px; }
.rdb-requirements {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 16px 18px;
}
.rdb-req-title { font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--gold); margin-bottom: 12px; }
.rdb-req-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; font-size: 12px; color: rgba(255,255,255,0.65); line-height: 1.5; }
.rdb-req-item:last-child { margin-bottom: 0; }
.rdb-req-num { min-width: 20px; height: 20px; border-radius: 50%; background: rgba(201,136,26,0.25); color: var(--gold); font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; margin-top: 1px; }

/* â”€â”€ CONTROLS â”€â”€ */
.controls { display:flex; align-items:center; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
.ctrl-label { font-size:11px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:var(--ink3); }
.ctrl-pill { background:var(--card); border:1.5px solid var(--rule); border-radius:100px; padding:6px 16px; font-size:12px; font-weight:600; color:var(--ink2); cursor:pointer; transition:all .18s; font-family:'DM Sans',sans-serif; }
.ctrl-pill:hover { border-color:var(--ink3); }
.ctrl-pill.on { background:var(--ink); color:#fff; border-color:var(--ink); }
.ctrl-sep { width:1px; height:20px; background:var(--rule); }
.data-note { font-size:11px; color:var(--ink3); font-family:'DM Mono',monospace; }

/* â”€â”€ KPI ROW â”€â”€ */
.kpi-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:20px; }
.kpi-card { background:var(--card); border:1px solid var(--rule); border-radius:var(--radius); padding:20px 22px; position:relative; overflow:hidden; }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.kpi-card:nth-child(1)::before { background:var(--gold); }
.kpi-card:nth-child(2)::before { background:var(--green); }
.kpi-card:nth-child(3)::before { background:var(--red); }
.kpi-card:nth-child(4)::before { background:var(--blue); }
.kpi-label { font-size:10px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:var(--ink3); margin-bottom:8px; }
.kpi-value { font-family:'Instrument Serif',serif; font-size:36px; line-height:1; color:var(--ink); margin-bottom:6px; }
.kpi-sub { font-size:12px; color:var(--ink2); }
.kpi-delta { display:inline-flex; align-items:center; gap:4px; font-size:11px; font-weight:600; padding:2px 8px; border-radius:100px; margin-top:8px; }
.kpi-delta.up { background:var(--green-pale); color:var(--green) }
.kpi-delta.down { background:var(--red-pale); color:var(--red) }
.kpi-delta.neutral { background:var(--gold-pale); color:var(--gold) }

/* â”€â”€ CHARTS â”€â”€ */
.charts-2 { display:grid; grid-template-columns:1.4fr 1fr; gap:16px; margin-bottom:16px; }
.charts-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:16px; }
.charts-full { margin-bottom:16px; }

/* â”€â”€ CARD â”€â”€ */
.card { background:var(--card); border:1px solid var(--rule); border-radius:var(--radius); overflow:hidden; }
.card-header { display:flex; align-items:flex-start; justify-content:space-between; padding:18px 20px 12px; gap:12px; }
.card-title { font-weight:600; font-size:13.5px; color:var(--ink); margin-bottom:3px; }
.card-desc { font-size:11.5px; color:var(--ink3); line-height:1.5; }
.card-tag { font-size:9px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; padding:3px 8px; border-radius:4px; white-space:nowrap; }
.tag-line { background:var(--blue-pale); color:var(--blue); }
.tag-bar { background:var(--gold-pale); color:var(--gold); }
.tag-area { background:var(--teal-pale); color:var(--teal); }
.tag-donut { background:var(--green-pale); color:var(--green); }
.tag-table { background:var(--red-pale); color:var(--red); }
.card-body { padding:0 20px 18px; }
.chart-wrap { position:relative; height:240px; }

/* â”€â”€ SQL TOGGLE â”€â”€ */
.sql-toggle { display:flex; align-items:center; gap:8px; padding:10px 20px; font-size:11px; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; color:var(--ink3); cursor:pointer; border-top:1px solid var(--rule); transition:background .15s; user-select:none; }
.sql-toggle:hover { background:var(--bg); color:var(--ink2); }
.sql-toggle .arrow { font-size:9px; transition:transform .2s; }
.sql-toggle.open .arrow { transform:rotate(90deg); }
.sql-panel { display:none; background:#14141C; padding:0; }
.sql-panel.open { display:block; }
.sql-meta { font-size:10px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.25); padding:14px 20px 8px; border-bottom:1px solid rgba(255,255,255,0.06); }
.sql-panel pre { padding:16px 20px; font-family:'DM Mono',monospace; font-size:11.5px; line-height:1.8; overflow-x:auto; color:#C8DFFF; white-space:pre; }
.kw { color:#FF9966; }
.fn { color:#82AAFF; }
.st { color:#C3E88D; }
.nb { color:#F78C6C; }
.cm { color:#546E7A; font-style:italic; }

/* â”€â”€ SECTOR TABLE â”€â”€ */
.sector-table { width:100%; border-collapse:collapse; }
.sector-table th { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--ink3); padding:12px 16px; text-align:left; border-bottom:2px solid var(--rule); white-space:nowrap; }
.sector-table td { padding:12px 16px; border-bottom:1px solid var(--rule); vertical-align:middle; }
.sector-table tr:last-child td { border-bottom:none; }
.sector-table tr:hover td { background:#FAF8F5; }
.sector-name { font-weight:600; font-size:13px; color:var(--ink); }
.sector-code { font-family:'DM Mono',monospace; font-size:11px; background:var(--bg); padding:2px 6px; border-radius:3px; color:var(--ink3); }
.trend-bar-wrap { display:flex; align-items:center; gap:8px; }
.trend-bar-track { width:80px; height:6px; background:var(--rule); border-radius:3px; overflow:hidden; }
.trend-bar-fill { height:100%; border-radius:3px; transition:width .4s ease; }
.trend-val { font-family:'DM Mono',monospace; font-size:12px; font-weight:600; min-width:48px; }
.trend-val.up { color:var(--green); }
.trend-val.down { color:var(--red); }

/* â”€â”€ AI INSIGHTS â”€â”€ */
.insights-section { margin-bottom:16px; }
.insights-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
.insights-headline { display:flex; align-items:center; gap:10px; }
.insights-headline h2 { font-family:'Instrument Serif',serif; font-size:22px; letter-spacing:-0.3px; color:var(--ink); }
.ai-badge { display:inline-flex; align-items:center; gap:6px; background:var(--ink); color:#fff; font-size:10px; font-weight:600; letter-spacing:2px; text-transform:uppercase; padding:4px 10px; border-radius:100px; }
.ai-badge-dot { width:6px; height:6px; border-radius:50%; background:var(--gold); box-shadow:0 0 5px var(--gold); animation:pulse 2s infinite; }
.generate-btn { display:inline-flex; align-items:center; gap:8px; background:var(--ink); color:#fff; border:none; border-radius:8px; padding:11px 22px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:background .18s,transform .15s; }
.generate-btn:hover { background:#2a2520; transform:translateY(-1px); }
.generate-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }
.generate-btn.loading svg { animation:spin 1s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.insights-how { background:var(--gold-pale); border:1px solid #E8CC90; border-radius:8px; padding:12px 16px; font-size:12px; color:#7A5A10; margin-bottom:16px; display:flex; gap:8px; }
.insights-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:14px; }
.insight-card { background:var(--card); border:1px solid var(--rule); border-radius:var(--radius); padding:20px; position:relative; overflow:hidden; opacity:0; transform:translateY(12px); transition:opacity .4s ease,transform .4s ease; }
.insight-card.visible { opacity:1; transform:translateY(0); }
.insight-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.insight-card.growth::before { background:var(--green); }
.insight-card.risk::before { background:var(--red); }
.insight-card.oppty::before { background:var(--blue); }
.insight-card.market::before { background:var(--gold); }
.insight-card.signal::before { background:var(--teal); }
.insight-type { font-size:9px; font-weight:700; letter-spacing:2.5px; text-transform:uppercase; margin-bottom:10px; }
.insight-card.growth .insight-type { color:var(--green); }
.insight-card.risk .insight-type { color:var(--red); }
.insight-card.oppty .insight-type { color:var(--blue); }
.insight-card.market .insight-type { color:var(--gold); }
.insight-card.signal .insight-type { color:var(--teal); }
.insight-title { font-family:'Instrument Serif',serif; font-size:16px; color:var(--ink); margin-bottom:8px; line-height:1.35; min-height:44px; }
.insight-body { font-size:12.5px; color:var(--ink2); line-height:1.65; }
.insight-body .cursor { display:inline-block; width:2px; height:14px; background:var(--ink); margin-left:2px; vertical-align:middle; animation:blink .7s step-end infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
.insights-summary { background:var(--ink); border-radius:var(--radius); padding:24px 28px; color:#fff; margin-bottom:14px; opacity:0; transform:translateY(8px); transition:opacity .5s ease .2s,transform .5s ease .2s; }
.insights-summary.visible { opacity:1; transform:translateY(0); }
.insights-summary-label { font-size:10px; font-weight:600; letter-spacing:2.5px; text-transform:uppercase; color:var(--gold); margin-bottom:12px; }
.insights-summary-text { font-family:'Instrument Serif',serif; font-size:18px; line-height:1.6; color:rgba(255,255,255,0.88); }
.insights-summary-text .cursor { display:inline-block; width:2px; height:18px; background:var(--gold); margin-left:3px; vertical-align:middle; animation:blink .7s step-end infinite; }
.insights-prompt-note { background:#14141C; border-radius:8px; padding:16px 20px; margin-bottom:14px; }
.insights-prompt-label { font-size:10px; font-weight:600; letter-spacing:2px; color:rgba(255,255,255,0.3); text-transform:uppercase; margin-bottom:8px; }
.insights-prompt-text { font-family:'DM Mono',monospace; font-size:11.5px; color:#C8DFFF; line-height:1.7; white-space:pre-wrap; }

/* â”€â”€ FOOTER â”€â”€ */
.footer { background:var(--ink); padding:20px 40px; display:flex; align-items:center; justify-content:space-between; gap:20px; flex-wrap:wrap; }
.footer-note { font-size:11px; color:rgba(255,255,255,0.35); }
.footer-sql-hint { font-family:'DM Mono',monospace; font-size:10px; color:rgba(255,255,255,0.2); }
</style>
</head>
<body>

<header class="header">
  <div class="header-brand">
    <span class="header-flag">ðŸ‡©ðŸ‡°</span>
    <div>
      <div class="header-title">Virkmart Â· Denmark Market Intelligence</div>
      <div class="header-sub">Real data Â· visma-marketing-cloud-master Â· Updated nightly</div>
    </div>
  </div>
  <div class="bq-badge">
    <div class="bq-dot"></div>
    <span class="bq-label">BigQuery Â· Live</span>
  </div>
</header>

<main>

  <!-- CONTROLS -->
  <div class="controls">
    <span class="ctrl-label">Period</span>
    <button class="ctrl-pill on" onclick="setPeriod(this,5)">2020â€“2024</button>
    <button class="ctrl-pill" onclick="setPeriod(this,4)">2021â€“2024</button>
    <button class="ctrl-pill" onclick="setPeriod(this,3)">2022â€“2024</button>
    <button class="ctrl-pill" onclick="setPeriod(this,2)">2023â€“2024</button>
    <div class="ctrl-sep"></div>
    <span class="data-note" id="data-note">Showing company formations Â· Status IN ('Aktiv','NORMAL') Â· virkmart.dim_company</span>
  </div>

  <!-- KPIs -->
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-label">Active Companies</div>
      <div class="kpi-value" id="kv-total">853K</div>
      <div class="kpi-sub">Current active registrations in Denmark</div>
      <span class="kpi-delta neutral" id="kv-total-delta">â–² +12.3% net 2020â€“2024</span>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Peak Formation Year</div>
      <div class="kpi-value" id="kv-peak">2021</div>
      <div class="kpi-sub" id="kv-peak-sub">103,884 new companies registered</div>
      <span class="kpi-delta up" id="kv-peak-delta">â–² Highest in 5-year window</span>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Net Formation Rate</div>
      <div class="kpi-value" id="kv-net">+29%</div>
      <div class="kpi-sub" id="kv-net-sub">Formations vs closures Â· 2024</div>
      <span class="kpi-delta up" id="kv-net-delta">â–² 83,087 formed / 64,249 closed</span>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Largest Sector</div>
      <div class="kpi-value" id="kv-top" style="font-size:24px;margin-top:4px">Financial</div>
      <div class="kpi-sub">160,849 active companies</div>
      <span class="kpi-delta neutral" id="kv-top-delta">â†’ NACE Section L</span>
    </div>
  </div>

  <!-- ROW 1 -->
  <div class="charts-2">
    <!-- Line: Annual formations by sector -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Annual New Company Formations by Sector</div>
          <div class="card-desc">New registrations per year Â· top 8 NACE sections Â· source: DateOfRegistration</div>
        </div>
        <span class="card-tag tag-line">Line</span>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="lineChart"></canvas></div>
      </div>
      <div class="sql-toggle" onclick="toggleSql(this)"><span class="arrow">â–¶</span> View BigQuery SQL</div>
      <div class="sql-panel">
        <div class="sql-meta">BigQuery Â· virkmart.dim_company Ã— custom_dimensions.Danish_DB_NaceCodes</div>
        <pre><span class="kw">SELECT</span>
  <span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span> c.DateOfRegistration)
    <span class="kw">AS</span> year,
  n_sect.Code       <span class="kw">AS</span> section,
  n_sect.NameEN     <span class="kw">AS</span> sector_name,
  <span class="fn">COUNT</span>(<span class="kw">DISTINCT</span> c.CvrNumber)
    <span class="kw">AS</span> formations

<span class="kw">FROM</span> <span class="st">`virkmart.dim_company`</span> c

<span class="kw">JOIN</span> <span class="st">`custom_dimensions.Danish_DB_NaceCodes`</span> n2
  <span class="kw">ON</span> <span class="fn">LEFT</span>(c.Industry,<span class="nb">2</span>) = n2.Code
  <span class="kw">AND</span> n2.Group = <span class="st">'2'</span>

<span class="kw">JOIN</span> <span class="st">`custom_dimensions.Danish_DB_NaceCodes`</span> n_sect
  <span class="kw">ON</span> n2.Parent = n_sect.Code
  <span class="kw">AND</span> n_sect.Group = <span class="st">'1'</span>

<span class="kw">WHERE</span>
  <span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span>
    c.DateOfRegistration)
  <span class="kw">BETWEEN</span> <span class="nb">2020</span> <span class="kw">AND</span> <span class="nb">2024</span>

<span class="kw">GROUP BY</span> year, section, sector_name
<span class="kw">ORDER BY</span> year, formations <span class="kw">DESC</span></pre>
      </div>
    </div>

    <!-- Bar: Formation growth 2020â†’2024 -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Formation Trend by Sector</div>
          <div class="card-desc">% change in new registrations Â· period start vs end year</div>
        </div>
        <span class="card-tag tag-bar">Bar</span>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="growthChart"></canvas></div>
      </div>
      <div class="sql-toggle" onclick="toggleSql(this)"><span class="arrow">â–¶</span> View BigQuery SQL</div>
      <div class="sql-panel">
        <div class="sql-meta">BigQuery Â· formations start vs end year comparison</div>
        <pre><span class="cm">-- Compare formations: first year vs last year</span>
<span class="kw">SELECT</span>
  sector_name,
  <span class="fn">COUNTIF</span>(yr = start_yr) <span class="kw">AS</span> f_start,
  <span class="fn">COUNTIF</span>(yr = end_yr)   <span class="kw">AS</span> f_end,
  <span class="fn">ROUND</span>(
    (<span class="fn">COUNTIF</span>(yr=end_yr) - <span class="fn">COUNTIF</span>(yr=start_yr))
    * <span class="nb">100.0</span>
    / <span class="fn">NULLIF</span>(<span class="fn">COUNTIF</span>(yr=start_yr),<span class="nb">0</span>),
  <span class="nb">1</span>) <span class="kw">AS</span> growth_pct

<span class="kw">FROM</span> formations_by_sector
<span class="kw">GROUP BY</span> sector_name
<span class="kw">ORDER BY</span> growth_pct <span class="kw">DESC</span></pre>
      </div>
    </div>
  </div>

  <!-- ROW 2 -->
  <div class="charts-3">
    <!-- Area: Top 4 sector formations -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Top 4 Sectors Â· Formation Trend</div>
          <div class="card-desc">Annual new registrations Â· stacked area</div>
        </div>
        <span class="card-tag tag-area">Area</span>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="areaChart"></canvas></div>
      </div>
      <div class="sql-toggle" onclick="toggleSql(this)"><span class="arrow">â–¶</span> View BigQuery SQL</div>
      <div class="sql-panel">
        <div class="sql-meta">BigQuery Â· top 4 sections by formation volume</div>
        <pre><span class="cm">-- Same query, filtered to top 4</span>
<span class="cm">-- sections by total formations</span>
<span class="kw">WHERE</span> n_sect.Code <span class="kw">IN</span> (
  <span class="st">'T'</span>,<span class="st">'L'</span>,<span class="st">'N'</span>,<span class="st">'G'</span>)</pre>
      </div>
    </div>

    <!-- Donut: Current active by section -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Active Companies by Sector</div>
          <div class="card-desc">Current snapshot Â· Status IN ('Aktiv','NORMAL')</div>
        </div>
        <span class="card-tag tag-donut">Donut</span>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="doughnut"></canvas></div>
      </div>
      <div class="sql-toggle" onclick="toggleSql(this)"><span class="arrow">â–¶</span> View BigQuery SQL</div>
      <div class="sql-panel">
        <div class="sql-meta">BigQuery Â· current active stock by section</div>
        <pre><span class="kw">SELECT</span>
  n_sect.Code    <span class="kw">AS</span> section,
  n_sect.NameEN  <span class="kw">AS</span> sector_name,
  <span class="fn">COUNT</span>(<span class="kw">DISTINCT</span> c.CvrNumber)
    <span class="kw">AS</span> company_count
<span class="kw">FROM</span> <span class="st">`virkmart.dim_company`</span> c
<span class="kw">JOIN</span> ... <span class="cm">-- NACE join</span>
<span class="kw">WHERE</span> c.Status <span class="kw">IN</span> (
  <span class="st">'Aktiv'</span>,<span class="st">'NORMAL'</span>)
<span class="kw">GROUP BY</span> section, sector_name
<span class="kw">ORDER BY</span> company_count <span class="kw">DESC</span></pre>
      </div>
    </div>

    <!-- Bar: Formations vs Closures -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Formations vs. Closures</div>
          <div class="card-desc">Annual market entries and exits Â· all sectors</div>
        </div>
        <span class="card-tag tag-bar">Bar</span>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="netChart"></canvas></div>
      </div>
      <div class="sql-toggle" onclick="toggleSql(this)"><span class="arrow">â–¶</span> View BigQuery SQL</div>
      <div class="sql-panel">
        <div class="sql-meta">BigQuery Â· formations vs closures by year</div>
        <pre><span class="kw">SELECT</span>
  <span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span>
    DateOfRegistration) yr,
  <span class="fn">COUNT</span>(<span class="kw">DISTINCT</span> CvrNumber)
    <span class="kw">AS</span> formations
<span class="kw">FROM</span> <span class="st">`virkmart.dim_company`</span>
<span class="kw">WHERE</span> yr <span class="kw">BETWEEN</span> <span class="nb">2020</span> <span class="kw">AND</span> <span class="nb">2024</span>
<span class="kw">GROUP BY</span> yr

<span class="cm">-- UNION with closures:</span>
<span class="kw">SELECT</span>
  <span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span>
    DateOfClosure) yr,
  <span class="fn">COUNT</span>(<span class="kw">DISTINCT</span> CvrNumber)
    <span class="kw">AS</span> closures
<span class="kw">FROM</span> <span class="st">`virkmart.dim_company`</span>
<span class="kw">WHERE</span> Status <span class="kw">NOT IN</span> (
  <span class="st">'Aktiv'</span>,<span class="st">'NORMAL'</span>)
  <span class="kw">AND</span> yr <span class="kw">BETWEEN</span> <span class="nb">2020</span> <span class="kw">AND</span> <span class="nb">2024</span>
<span class="kw">GROUP BY</span> yr</pre>
      </div>
    </div>
  </div>

  <!-- ROW 3: Sector Table -->
  <div class="charts-full">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Sector Scorecard â€” All Industries Ranked by Active Count</div>
          <div class="card-desc">Real data Â· formation trend = % change in new registrations from period start to end year</div>
        </div>
        <span class="card-tag tag-table">Ranked Table</span>
      </div>
      <div class="card-body" style="padding:0">
        <table class="sector-table">
          <thead>
            <tr>
              <th style="padding-left:20px">#</th>
              <th>Sector</th>
              <th>NACE</th>
              <th>Currently Active</th>
              <th id="th-start">Formations 2020</th>
              <th id="th-end">Formations 2024</th>
              <th id="th-growth" style="min-width:200px">Formation Trend</th>
              <th>Signal</th>
            </tr>
          </thead>
          <tbody id="sector-tbody"></tbody>
        </table>
      </div>
      <div class="sql-toggle" onclick="toggleSql(this)"><span class="arrow">â–¶</span> View BigQuery SQL</div>
      <div class="sql-panel">
        <div class="sql-meta">BigQuery Â· full sector scorecard â€” real query used to build this table</div>
        <pre><span class="kw">SELECT</span>
  n_sect.Code <span class="kw">AS</span> section,
  n_sect.NameEN <span class="kw">AS</span> sector_name,
  <span class="fn">COUNTIF</span>(<span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span>
    c.DateOfRegistration) = <span class="nb">2020</span>)
    <span class="kw">AS</span> f2020,
  <span class="fn">COUNTIF</span>(<span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span>
    c.DateOfRegistration) = <span class="nb">2024</span>)
    <span class="kw">AS</span> f2024,
  <span class="fn">COUNT</span>(<span class="kw">DISTINCT CASE WHEN</span>
    c.Status <span class="kw">IN</span> (<span class="st">'Aktiv'</span>,<span class="st">'NORMAL'</span>)
    <span class="kw">THEN</span> c.CvrNumber <span class="kw">END</span>)
    <span class="kw">AS</span> currently_active

<span class="kw">FROM</span> <span class="st">`virkmart.dim_company`</span> c
<span class="kw">JOIN</span> <span class="st">`Danish_DB_NaceCodes`</span> n2
  <span class="kw">ON</span> <span class="fn">LEFT</span>(c.Industry,<span class="nb">2</span>)=n2.Code
  <span class="kw">AND</span> n2.Group=<span class="st">'2'</span>
<span class="kw">JOIN</span> <span class="st">`Danish_DB_NaceCodes`</span> n_sect
  <span class="kw">ON</span> n2.Parent=n_sect.Code
  <span class="kw">AND</span> n_sect.Group=<span class="st">'1'</span>

<span class="kw">WHERE</span> <span class="fn">EXTRACT</span>(<span class="kw">YEAR FROM</span>
  c.DateOfRegistration)
  <span class="kw">BETWEEN</span> <span class="nb">2020</span> <span class="kw">AND</span> <span class="nb">2024</span>

<span class="kw">GROUP BY</span> section, sector_name
<span class="kw">ORDER BY</span> currently_active <span class="kw">DESC</span></pre>
      </div>
    </div>
  </div>

  <!-- AI INSIGHTS -->
  <div class="insights-section" id="insights-section">
    <div class="insights-header">
      <div class="insights-headline">
        <h2>Dynamic Insights</h2>
        <span class="ai-badge"><span class="ai-badge-dot"></span>Claude API</span>
      </div>
      <button class="generate-btn" id="gen-btn" onclick="generateInsights()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
        Generate Insights from Real Data
      </button>
    </div>
    <div class="insights-how">
      <span>ðŸ’¡</span>
      <span><strong>How this works:</strong> The real BQ numbers above are serialised and sent to the Claude API, which analyses them and streams back business insights. Works automatically inside claude.ai. On external hosting, requires an API key or backend proxy.</span>
    </div>
    <div class="insights-prompt-note" id="prompt-preview">
      <div class="insights-prompt-label">Prompt sent to Claude API â†’ claude-sonnet-4-20250514</div>
      <div class="insights-prompt-text" id="prompt-text">// Click "Generate Insights from Real Data" to see the live prompt and streamed response</div>
    </div>
    <div class="insights-grid">
      <div class="insight-card growth" id="ic-0"><div class="insight-type">Growth Signal</div><div class="insight-title" id="it-0">&nbsp;</div><div class="insight-body" id="ib-0"><span style="color:var(--ink3);font-size:12px">Awaiting real data analysisâ€¦</span></div></div>
      <div class="insight-card risk"   id="ic-1"><div class="insight-type">Risk Alert</div><div class="insight-title" id="it-1">&nbsp;</div><div class="insight-body" id="ib-1"><span style="color:var(--ink3);font-size:12px">Awaiting real data analysisâ€¦</span></div></div>
      <div class="insight-card oppty" id="ic-2"><div class="insight-type">Opportunity</div><div class="insight-title" id="it-2">&nbsp;</div><div class="insight-body" id="ib-2"><span style="color:var(--ink3);font-size:12px">Awaiting real data analysisâ€¦</span></div></div>
    </div>
    <div class="insights-grid">
      <div class="insight-card market" id="ic-3"><div class="insight-type">Market Structure</div><div class="insight-title" id="it-3">&nbsp;</div><div class="insight-body" id="ib-3"><span style="color:var(--ink3);font-size:12px">Awaiting real data analysisâ€¦</span></div></div>
      <div class="insight-card signal" id="ic-4"><div class="insight-type">Leading Signal</div><div class="insight-title" id="it-4">&nbsp;</div><div class="insight-body" id="ib-4"><span style="color:var(--ink3);font-size:12px">Awaiting real data analysisâ€¦</span></div></div>
      <div class="insight-card oppty" id="ic-5"><div class="insight-type">Visma Implication</div><div class="insight-title" id="it-5">&nbsp;</div><div class="insight-body" id="ib-5"><span style="color:var(--ink3);font-size:12px">Awaiting real data analysisâ€¦</span></div></div>
    </div>
    <div class="insights-summary" id="insights-summary">
      <div class="insights-summary-label">Executive Summary</div>
      <div class="insights-summary-text" id="insights-summary-text">
        <span style="color:rgba(255,255,255,0.3);font-family:'DM Sans',sans-serif;font-size:14px;">Generate insights to see an executive summaryâ€¦</span>
      </div>
    </div>
  </div>

  <!-- HOW THIS WAS BUILT -->
  <div class="real-data-banner">
    <div class="rdb-left">
      <div class="rdb-title">Built with real data. In one conversation.</div>
      <div class="rdb-desc">
        Every number on this page was queried live from <strong>visma-marketing-cloud-master.virkmart.dim_company</strong>
        â€” 2.2M company records from the Danish CVR registry, updated nightly.
        No backend, no ETL pipeline, no BI team. Built directly by Claude using MCP to query BigQuery,
        then baking the results into a self-contained HTML dashboard.
        <strong>Data snapshot: 20 February 2026.</strong>
      </div>
      <div class="rdb-chips">
        <span class="rdb-chip">Source <span>virkmart.dim_company</span></span>
        <span class="rdb-chip">Records <span>2,227,643</span></span>
        <span class="rdb-chip">Active <span>853,240</span></span>
        <span class="rdb-chip">Queried <span>20 Feb 2026</span></span>
        <span class="rdb-chip">Build time <span>~15 min</span></span>
      </div>
    </div>
    <div class="rdb-right">
      <div class="rdb-requirements">
        <div class="rdb-req-title">To replicate this yourself</div>
        <div class="rdb-req-item">
          <div class="rdb-req-num">1</div>
          <div><strong style="color:rgba(255,255,255,0.8)">BigQuery read access</strong><br>Permission to query the visma-marketing-cloud-master project</div>
        </div>
        <div class="rdb-req-item">
          <div class="rdb-req-num">2</div>
          <div><strong style="color:rgba(255,255,255,0.8)">Claude Pro + MCP</strong><br>BigQuery MCP server configured locally â€” lets Claude query BQ directly in chat</div>
        </div>
        <div class="rdb-req-item">
          <div class="rdb-req-num">3</div>
          <div><strong style="color:rgba(255,255,255,0.8)">~15 minutes</strong><br>Ask Claude to explore the tables, run the queries, build the dashboard</div>
        </div>
      </div>
    </div>
  </div>

</main>

<footer class="footer">
  <div class="footer-note">Real data Â· visma-marketing-cloud-master.virkmart.dim_company Â· 2,227,643 records Â· Queried 20 Feb 2026 Â· Built with Claude + BigQuery MCP + Chart.js</div>
  <div class="footer-sql-hint">SELECT * FROM virkmart.dim_company WHERE Status IN ('Aktiv','NORMAL') -- 853,240 rows</div>
</footer>

<script>
// â”€â”€ REAL DATA FROM BIGQUERY (queried 20 Feb 2026) â”€â”€â”€â”€â”€â”€â”€â”€
// Source: visma-marketing-cloud-master.virkmart.dim_company
// All numbers are real â€” no synthetic values

const ALL_YEARS = [2020, 2021, 2022, 2023, 2024];

// Real formations per year per sector (from BQ query)
const SECTORS = [
  {
    name: 'Other Service Activities', short: 'Other Services', code: 'T',
    active: 132222,
    formations: [17984, 14537, 15002, 19987, 16551],
    color: '#1A4A8A'
  },
  {
    name: 'Financial & Insurance Activities', short: 'Financial', code: 'L',
    active: 160849,
    formations: [13642, 19948, 12168, 11393, 11291],
    color: '#C9881A'
  },
  {
    name: 'Professional, Scientific & Technical', short: 'Prof. & Scientific', code: 'N',
    active: 89833,
    formations: [10671, 12424, 9314, 10001, 10096],
    color: '#1E6B42'
  },
  {
    name: 'Wholesale & Retail Trade', short: 'Wholesale & Retail', code: 'G',
    active: 63265,
    formations: [9266, 9611, 6917, 7116, 7010],
    color: '#9B2020'
  },
  {
    name: 'Construction', short: 'Construction', code: 'F',
    active: 46772,
    formations: [5751, 6691, 5243, 4815, 5002],
    color: '#7B3FA0'
  },
  {
    name: 'Administrative & Support Services', short: 'Admin & Support', code: 'O',
    active: 37746,
    formations: [5509, 6061, 5133, 5484, 5736],
    color: '#1A6878'
  },
  {
    name: 'Real Estate Activities', short: 'Real Estate', code: 'M',
    active: 72699,
    formations: [4643, 5201, 3749, 3297, 3410],
    color: '#A05020'
  },
  {
    name: 'Human Health & Social Work', short: 'Health & Social', code: 'R',
    active: 46413,
    formations: [3746, 4064, 3704, 3967, 4016],
    color: '#C04080'
  },
];

// Real total formations & closures (all sectors)
const ALL_FORMATIONS = [92758, 103884, 81272, 85530, 83087];
const ALL_CLOSURES   = [69039, 62324, 66122, 67694, 64249];

// Active period state
let startIdx = 0; // 2020
let endIdx   = 4; // 2024

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FONT = "'DM Sans',sans-serif";
const gridColor = '#E8E4DC';
Chart.defaults.font.family = FONT;
Chart.defaults.color = '#5C5650';

function activeYears()     { return ALL_YEARS.slice(startIdx, endIdx+1); }
function activeFormations() { return ALL_FORMATIONS.slice(startIdx, endIdx+1); }
function activeClosures()   { return ALL_CLOSURES.slice(startIdx, endIdx+1); }
function sectorFormations(s){ return s.formations.slice(startIdx, endIdx+1); }
function formationGrowth(s) {
  const start = s.formations[startIdx], end = s.formations[endIdx];
  return +((end - start) * 100 / start).toFixed(1);
}

// â”€â”€ CHART INSTANCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lineChart, growthChart, areaChart, doughnutChart, netChart;

function buildCharts() {
  const years = activeYears();

  // 1. LINE
  lineChart = new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels: years,
      datasets: SECTORS.map(s => ({
        label: s.short,
        data: sectorFormations(s),
        borderColor: s.color,
        backgroundColor: s.color + '15',
        borderWidth: 2, pointRadius: 4, pointHoverRadius: 7,
        tension: 0.35, fill: false
      }))
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 10, padding: 12, font: { size: 10.5 } } },
        tooltip: { callbacks: { label: ctx => `  ${ctx.dataset.label}: ${ctx.raw.toLocaleString()} formations` } }
      },
      scales: {
        x: { grid: { color: gridColor }, ticks: { font: { size: 11 } } },
        y: { grid: { color: gridColor }, ticks: { font: { size: 11 }, callback: v => (v/1000).toFixed(0)+'K' } }
      }
    }
  });

  // 2. GROWTH BAR
  const gd = buildGrowthData();
  growthChart = new Chart(document.getElementById('growthChart'), {
    type: 'bar',
    data: {
      labels: gd.map(d => d.short),
      datasets: [{
        label: `Formation trend ${ALL_YEARS[startIdx]}â†’${ALL_YEARS[endIdx]}`,
        data: gd.map(d => d.pct),
        backgroundColor: gd.map(d => d.pct >= 0 ? '#1E6B4222' : '#9B202022'),
        borderColor: gd.map(d => d.pct >= 0 ? '#1E6B42' : '#9B2020'),
        borderWidth: 2, borderRadius: 5
      }]
    },
    options: {
      indexAxis: 'y', responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ` ${ctx.raw > 0 ? '+' : ''}${ctx.raw}%` } }
      },
      scales: {
        x: { grid: { color: gridColor }, ticks: { callback: v => v+'%', font: { size: 11 } }, min: -35, max: 50 },
        y: { grid: { display: false }, ticks: { font: { size: 11 } } }
      }
    }
  });

  // 3. AREA (top 4)
  const TOP4 = SECTORS.slice(0, 4);
  areaChart = new Chart(document.getElementById('areaChart'), {
    type: 'line',
    data: {
      labels: years,
      datasets: TOP4.map(s => ({
        label: s.short,
        data: sectorFormations(s),
        borderColor: s.color,
        backgroundColor: s.color + '28',
        borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3
      }))
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10, font: { size: 10.5 } } } },
      scales: {
        x: { grid: { color: gridColor }, ticks: { font: { size: 11 } } },
        y: { grid: { color: gridColor }, ticks: { font: { size: 11 }, callback: v => (v/1000).toFixed(0)+'K' } }
      }
    }
  });

  // 4. DOUGHNUT (current active stock)
  doughnutChart = new Chart(document.getElementById('doughnut'), {
    type: 'doughnut',
    data: {
      labels: SECTORS.map(s => s.short),
      datasets: [{
        data: SECTORS.map(s => s.active),
        backgroundColor: SECTORS.map(s => s.color + 'CC'),
        borderColor: '#ffffff', borderWidth: 2, hoverOffset: 8
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '62%',
      plugins: {
        legend: { position: 'right', labels: { boxWidth: 10, padding: 9, font: { size: 10 } } },
        tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw.toLocaleString()} active` } }
      }
    }
  });

  // 5. FORMATIONS vs CLOSURES
  netChart = new Chart(document.getElementById('netChart'), {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        { label: 'Formations', data: activeFormations(), backgroundColor: '#1E6B4233', borderColor: '#1E6B42', borderWidth: 2, borderRadius: 4 },
        { label: 'Closures',   data: activeClosures(),   backgroundColor: '#9B202033', borderColor: '#9B2020', borderWidth: 2, borderRadius: 4 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10, font: { size: 11 } } } },
      scales: {
        x: { grid: { color: gridColor }, ticks: { font: { size: 11 } } },
        y: { grid: { color: gridColor }, ticks: { font: { size: 11 }, callback: v => (v/1000).toFixed(0)+'K' } }
      }
    }
  });
}

function buildGrowthData() {
  return SECTORS.map(s => ({ ...s, pct: formationGrowth(s) }))
    .sort((a,b) => b.pct - a.pct);
}

// â”€â”€ REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refresh() {
  const years = activeYears();
  const sy = ALL_YEARS[startIdx], ey = ALL_YEARS[endIdx];

  lineChart.data.labels = years;
  lineChart.data.datasets.forEach((ds,i) => { ds.data = sectorFormations(SECTORS[i]); });
  lineChart.update();

  const gd = buildGrowthData();
  growthChart.data.labels = gd.map(d => d.short);
  growthChart.data.datasets[0].label = `Formation trend ${sy}â†’${ey}`;
  growthChart.data.datasets[0].data = gd.map(d => d.pct);
  growthChart.data.datasets[0].backgroundColor = gd.map(d => d.pct >= 0 ? '#1E6B4222' : '#9B202022');
  growthChart.data.datasets[0].borderColor = gd.map(d => d.pct >= 0 ? '#1E6B42' : '#9B2020');
  growthChart.update();

  areaChart.data.labels = years;
  areaChart.data.datasets.forEach((ds,i) => { ds.data = sectorFormations(SECTORS[i]); });
  areaChart.update();

  netChart.data.labels = years;
  netChart.data.datasets[0].data = activeFormations();
  netChart.data.datasets[1].data = activeClosures();
  netChart.update();

  refreshKPIs(sy, ey);
  refreshTable(sy, ey);

  const thS = document.getElementById('th-start');
  const thE = document.getElementById('th-end');
  const thG = document.getElementById('th-growth');
  if (thS) thS.textContent = `Formations ${sy}`;
  if (thE) thE.textContent = `Formations ${ey}`;
  if (thG) thG.textContent = `${sy}â†’${ey} Trend`;

  document.getElementById('data-note').textContent =
    `Showing formations ${sy}â€“${ey} Â· Status IN ('Aktiv','NORMAL') Â· virkmart.dim_company`;
}

function refreshKPIs(sy, ey) {
  const forms = activeFormations();
  const closes = activeClosures();
  const peakIdx = forms.indexOf(Math.max(...forms));
  const peakYear = activeYears()[peakIdx];
  const lastForm = forms[forms.length-1];
  const lastClose = closes[closes.length-1];
  const netPct = ((lastForm - lastClose) / lastClose * 100).toFixed(0);

  document.getElementById('kv-net').textContent = `+${netPct}%`;
  document.getElementById('kv-net-sub').textContent = `Formations vs closures Â· ${ey}`;
  document.getElementById('kv-net-delta').textContent = `â–² ${lastForm.toLocaleString()} formed / ${lastClose.toLocaleString()} closed`;

  document.getElementById('kv-peak').textContent = peakYear;
  document.getElementById('kv-peak-sub').textContent = `${Math.max(...forms).toLocaleString()} new companies registered`;
}

function refreshTable(sy, ey) {
  const tbody = document.getElementById('sector-tbody');
  tbody.innerHTML = '';
  const sorted = [...SECTORS].sort((a,b) => b.active - a.active);
  sorted.forEach((s, i) => {
    const pct = formationGrowth(s);
    const isUp = pct >= 0;
    const barW = Math.min(Math.abs(pct) / 35 * 100, 100);
    const status = pct > 5 ? 'â–² Accelerating' : pct < -5 ? 'â–¼ Decelerating' : 'â†’ Stable';
    const statusColor = pct > 5 ? 'var(--green)' : pct < -5 ? 'var(--red)' : 'var(--gold)';
    const statusBg = pct > 5 ? 'var(--green-pale)' : pct < -5 ? 'var(--red-pale)' : 'var(--gold-pale)';
    tbody.innerHTML += `<tr>
      <td style="padding-left:20px;color:var(--ink3);font-size:12px">${i+1}</td>
      <td><div class="sector-name">${s.name}</div></td>
      <td><span class="sector-code">${s.code}</span></td>
      <td style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600">${s.active.toLocaleString()}</td>
      <td style="font-family:'DM Mono',monospace;font-size:13px;color:var(--ink2)">${s.formations[startIdx].toLocaleString()}</td>
      <td style="font-family:'DM Mono',monospace;font-size:13px;color:var(--ink2)">${s.formations[endIdx].toLocaleString()}</td>
      <td>
        <div class="trend-bar-wrap">
          <div class="trend-bar-track">
            <div class="trend-bar-fill" style="width:${barW}%;background:${isUp?'var(--green)':'var(--red)'}"></div>
          </div>
          <span class="trend-val ${isUp?'up':'down'}">${isUp?'+':''}${pct.toFixed(1)}%</span>
        </div>
      </td>
      <td><span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:100px;background:${statusBg};color:${statusColor}">${status}</span></td>
    </tr>`;
  });
}

// â”€â”€ PERIOD SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPeriod(btn, numYears) {
  document.querySelectorAll('.ctrl-pill').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  startIdx = ALL_YEARS.length - numYears;
  endIdx   = ALL_YEARS.length - 1;
  refresh();
}

// â”€â”€ SQL TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSql(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
}

// â”€â”€ CLAUDE API â€” DYNAMIC INSIGHTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDataSummary() {
  const sy = ALL_YEARS[startIdx], ey = ALL_YEARS[endIdx];
  const forms = activeFormations(), closes = activeClosures();
  const sectorData = SECTORS.map(s => ({
    name: s.name, code: s.code, active: s.active,
    formStart: s.formations[startIdx], formEnd: s.formations[endIdx],
    pct: formationGrowth(s)
  })).sort((a,b) => b.pct - a.pct);

  const formObj = {}, closeObj = {};
  activeYears().forEach((y,i) => { formObj[y] = forms[i]; closeObj[y] = closes[i]; });

  return { period: `${sy}â€“${ey}`, country: 'Denmark',
    source: 'visma-marketing-cloud-master.virkmart.dim_company (REAL DATA)',
    dataDate: '20 February 2026', totalActive: 853240,
    totalRecords: 2227643, sectors: sectorData,
    formations: formObj, closures: closeObj };
}

function buildPrompt(data) {
  const sectorLines = data.sectors.map(s =>
    `  - ${s.name} (${s.code}): ${s.active.toLocaleString()} currently active | formations ${data.period.split('â€“')[0]}: ${s.formStart.toLocaleString()} â†’ ${data.period.split('â€“')[1]}: ${s.formEnd.toLocaleString()} (${s.pct > 0 ? '+' : ''}${s.pct}%)`
  ).join('\n');
  const formLines = Object.entries(data.formations).map(([y,v]) =>
    `  - ${y}: ${v.toLocaleString()} formations / ${data.closures[y].toLocaleString()} closures / net +${(v-data.closures[y]).toLocaleString()}`
  ).join('\n');

  return `You are a senior business analyst at Visma Group â€” a portfolio of 200+ B2B SaaS companies in Europe focused on ERP, accounting, and payroll for SMEs.

You have just queried the REAL Danish company registry (CVR) from BigQuery. This is not synthetic data â€” these are actual numbers from ${data.source}, queried on ${data.dataDate}. The database contains ${data.totalRecords.toLocaleString()} total records.

PERIOD ANALYSED: ${data.period}
COUNTRY: ${data.country}
TOTAL CURRENTLY ACTIVE COMPANIES: ${data.totalActive.toLocaleString()}

SECTOR BREAKDOWN â€” Currently Active + Formation Trend ${data.period}:
${sectorLines}

ANNUAL MARKET DYNAMICS (all sectors combined):
${formLines}

Generate exactly 6 business insights and an executive summary. Respond ONLY with valid JSON â€” no markdown, no backticks.

{
  "insights": [
    {
      "type": "growth|risk|oppty|market|signal",
      "title": "Short punchy title (max 8 words)",
      "body": "2-3 sentences grounded in specific real numbers. Be direct, analytical, actionable.",
      "stat": "One headline metric"
    }
  ],
  "summary": "3-4 sentence executive summary for Visma leadership. What do these real Danish market numbers mean for our growth strategy, product focus, and sales priorities?"
}

Cover in order: (1) key growth signal, (2) risk alert, (3) concrete opportunity, (4) market structure insight, (5) forward-looking signal, (6) Visma-specific strategic implication.`;
}

async function generateInsights() {
  const btn = document.getElementById('gen-btn');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Analysing real data with Claudeâ€¦`;

  const data = buildDataSummary();
  const prompt = buildPrompt(data);
  document.getElementById('prompt-text').textContent = prompt.slice(0, 1000) + '\n\n[â€¦ full prompt sent to API]';

  for (let i = 0; i < 6; i++) {
    document.getElementById(`it-${i}`).textContent = '';
    document.getElementById(`ib-${i}`).innerHTML = '<span class="cursor"></span>';
    document.getElementById(`ic-${i}`).classList.remove('visible');
  }
  document.getElementById('insights-summary').classList.remove('visible');
  document.getElementById('insights-summary-text').innerHTML = '<span class="cursor"></span>';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const json   = await res.json();
    const raw    = json.content?.[0]?.text || '';
    const parsed = JSON.parse(raw.replace(/```json|```/g, '').trim());
    const TYPES  = ['growth','risk','oppty','market','signal','oppty'];

    parsed.insights.forEach((ins, i) => {
      if (i >= 6) return;
      const card = document.getElementById(`ic-${i}`);
      card.className = `insight-card ${TYPES[i]}`;
      const title = document.getElementById(`it-${i}`);
      const body  = document.getElementById(`ib-${i}`);
      title.textContent = '';
      let ti = 0;
      const titleIv = setInterval(() => {
        if (ti < ins.title.length) title.textContent += ins.title[ti++];
        else clearInterval(titleIv);
      }, 28);
      setTimeout(() => {
        body.innerHTML = '<span class="cursor"></span>';
        let bi = 0;
        const str = (ins.body || '') + (ins.stat ? `\n\nâ†’ ${ins.stat}` : '');
        const cur = body.querySelector('.cursor');
        const bodyIv = setInterval(() => {
          if (bi < str.length) {
            const ch = str[bi++];
            cur.before(ch === '\n' ? document.createElement('br') : document.createTextNode(ch));
          } else { clearInterval(bodyIv); cur.remove(); }
        }, 14);
      }, 200 + i * 120);
      setTimeout(() => card.classList.add('visible'), 80 + i * 100);
    });

    setTimeout(() => {
      const el = document.getElementById('insights-summary');
      const tx = document.getElementById('insights-summary-text');
      el.classList.add('visible');
      tx.innerHTML = '<span class="cursor"></span>';
      let si = 0;
      const str = parsed.summary || '';
      const cur = tx.querySelector('.cursor');
      const sumIv = setInterval(() => {
        if (si < str.length) cur.before(document.createTextNode(str[si++]));
        else { clearInterval(sumIv); cur.remove(); }
      }, 18);
    }, 700);

  } catch (err) {
    console.error(err);
    const isAuthOrCors = err?.message?.includes('401') || err?.message?.includes('Failed to fetch') || err?.message?.includes('NetworkError');
    const card = document.getElementById('ic-0');
    card.className = 'insight-card market';
    document.getElementById('it-0').textContent = isAuthOrCors ? 'API key required to generate insights' : 'Could not reach Claude API';
    document.getElementById('ib-0').innerHTML = isAuthOrCors
      ? 'This dashboard is calling the Claude API directly from the browser. Inside claude.ai, authentication is handled automatically. On an external host, you need an API key in the request headers, or a small backend proxy. The charts and real BQ data above work for everyone regardless.'
      : `Error: ${err?.message}. Check browser console.`;
    card.classList.add('visible');
  }

  btn.disabled = false;
  btn.classList.remove('loading');
  btn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Regenerate Insights`;
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildCharts();
refreshKPIs(ALL_YEARS[startIdx], ALL_YEARS[endIdx]);
refreshTable(ALL_YEARS[startIdx], ALL_YEARS[endIdx]);
</script>
</body>
</html>
